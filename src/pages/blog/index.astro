---
import BaseLayout from '../../layouts/BaseLayout.astro';
import BlogPostCard from '../../components/BlogPostCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('blog', ({ data }) => !data.draft);
const posts = allPosts.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

// Collect all unique tags
const allTags = [...new Set(posts.flatMap((post) => post.data.tags))].sort();

// Get filter tag from URL
const activeTag = Astro.url.searchParams.get('tag');
const filteredPosts = activeTag
  ? posts.filter((post) => post.data.tags.includes(activeTag))
  : posts;
---

<BaseLayout title="Blog" description="Thoughts on data science, machine learning, philosophy, and more.">
  <h1 class="text-3xl font-bold tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl">
    Blog
  </h1>
  <p class="mt-4 text-gray-600 dark:text-gray-400">
    Thoughts on data science, machine learning, philosophy, and more.
  </p>

  <!-- Tag filter -->
  {allTags.length > 0 && (
    <div class="mt-6 flex flex-wrap gap-2">
      <a
        href="/blog/"
        class:list={[
          'rounded-full px-3 py-1 text-xs font-medium transition-colors',
          !activeTag
            ? 'bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900'
            : 'bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700',
        ]}
      >
        All
      </a>
      {allTags.map((tag) => (
        <a
          href={`/blog/?tag=${tag}`}
          class:list={[
            'rounded-full px-3 py-1 text-xs font-medium transition-colors',
            activeTag === tag
              ? 'bg-gray-900 text-white dark:bg-gray-100 dark:text-gray-900'
              : 'bg-gray-100 text-gray-600 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-400 dark:hover:bg-gray-700',
          ]}
        >
          {tag}
        </a>
      ))}
    </div>
  )}

  <div class="mt-10 space-y-10">
    {filteredPosts.length > 0 ? (
      filteredPosts.map((post) => (
        <BlogPostCard
          title={post.data.title}
          description={post.data.description}
          pubDate={post.data.pubDate}
          tags={post.data.tags}
          slug={post.id}
        />
      ))
    ) : (
      <p class="text-gray-500 dark:text-gray-400">No posts found.</p>
    )}
  </div>
</BaseLayout>
